# 快速入门

<cite>
**本文档中引用的文件**
- [QUICK_START.md](file://QUICK_START.md)
- [README.md](file://README.md)
- [mlx-grpo.py](file://mlx-grpo.py)
- [configs/smoke_test.toml](file://configs/smoke_test.toml)
- [configs/prod.toml](file://configs/prod.toml)
- [utils/README.md](file://utils/README.md)
- [pyproject.toml](file://pyproject.toml)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [安装步骤](#安装步骤)
4. [快速开始](#快速开始)
5. [配置文件详解](#配置文件详解)
6. [命令行参数详解](#命令行参数详解)
7. [典型使用场景](#典型使用场景)
8. [环境变量配置](#环境变量配置)
9. [参数扫描与优化](#参数扫描与优化)
10. [故障排除](#故障排除)
11. [下一步](#下一步)

## 简介

MLX-GRPO是一个基于Apple Silicon的纯MLX框架大型语言模型训练框架，专门实现Group-based Relative Policy Optimization (GRPO)算法。本快速入门指南旨在让您在2分钟内启动首次训练，无需复杂的配置过程。

### 核心特性
- **纯MLX集成**：仅在Apple Silicon上运行，利用Metal后端
- **GRPO训练管道**：实现多种奖励函数优化链式思维响应
- **通用模型支持**：内置转换工具支持任意Hugging Face模型
- **数据集预处理**：使用GSM8K数据集测试多步推理能力

## 系统要求

### 硬件要求
- **Apple Silicon Mac**（M1/M2/M3/M4系列）
- 至少 **8GB RAM**（推荐16GB以上）
- 足够的存储空间（模型文件大小从几十MB到几十GB不等）

### 软件要求
- **Python 3.11+**（推荐最新版本）
- **macOS 14+**（推荐最新版本）
- **uv CLI**（项目管理工具）

## 安装步骤

### 1. 克隆仓库

```bash
git clone https://github.com/Doriandarko/MLX-GRPO.git
cd MLX-GRPO
```

### 2. 创建虚拟环境

```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. 安装uv包管理器

```bash
pip install uv
```

### 4. 安装依赖

```bash
uv sync
```

这将自动安装所有必要的依赖项，包括MLX、MLX-LM、数据集处理库等。

## 快速开始

### 第一步：选择配置文件

系统提供了三个预配置的训练设置：

| 配置文件 | 使用场景 | 训练速度 | 质量等级 | 推荐用途 |
|----------|----------|----------|----------|----------|
| `smoke_test.toml` | 快速测试与调试 | 🚀 最快 | 基础 | 验证安装 |
| `prod.toml` | 生产级训练 | 🐌 慢 | 最佳 | 正式训练 |
| `medium.toml` | 平衡实验 | ⚡ 中等 | 良好 | 初步实验 |

### 第二步：运行首次训练

#### 快速测试（推荐）
```bash
# 使用烟雾测试配置进行快速验证
uv run mlx-grpo.py --config configs/smoke_test.toml
```

#### 生产级训练
```bash
# 使用生产配置进行完整训练
uv run mlx-grpo.py --config configs/prod.toml
```

#### 自定义配置
```bash
# 使用默认配置并自定义参数
uv run mlx-grpo.py --config configs/prod.toml \
  --set learning_rate=5e-7 \
  --set num_generations=32 \
  --set output_dir="outputs/custom-experiment"
```

**段落来源**
- [QUICK_START.md](file://QUICK_START.md#L1-L75)
- [README.md](file://README.md#L18-L86)

## 配置文件详解

### smoke_test.toml - 快速测试配置

这是最快的配置选项，适合验证系统是否正常工作：

```toml
# 最小化设置用于快速测试
model_name = "utils/mlx_model"    # ← 已转换的量化模型
output_dir = "outputs/smoke-test"
run_name   = "smoke-test-run"

# 极简训练设置
learning_rate = 1e-6
num_generations = 2                # 只生成2个样本
max_new_tokens = 32                # 短序列
max_train_samples = 50             # 仅使用50个样本
eval_steps = 5                     # 频繁评估
```

### prod.toml - 生产级配置

完整的DeepSeek风格配置，适合实际训练：

```toml
# 生产质量设置
model_name = "utils/mlx_model"
output_dir = "outputs/production-run"
run_name   = "qwen-1.5b-production"

# 标准训练参数
learning_rate = 1e-6
num_generations = 16               # 16个样本获得良好优势估计
max_new_tokens = 256               # 较长完成以获得完整推理
max_train_samples = 2000           # 训练2000个样本
```

### 配置文件结构

每个配置文件都包含以下核心部分：

```toml
# 模型配置
model_name = "Qwen/Qwen2.5-1.5B-Instruct"
output_dir = "outputs/my_run"
run_name   = "my-experiment"

# 训练参数
learning_rate = 1e-6
num_generations = 8
max_new_tokens = 128
temperature = 0.7

# 系统设置
seed = 0
use_compile = true
```

**段落来源**
- [configs/smoke_test.toml](file://configs/smoke_test.toml#L1-L38)
- [configs/prod.toml](file://configs/prod.toml#L1-L40)

## 命令行参数详解

### 基本语法

```bash
uv run mlx-grpo.py [OPTIONS]
```

### 主要参数

#### --config
指定配置文件路径：
```bash
# 使用特定配置
uv run mlx-grpo.py --config configs/smoke_test.toml

# 使用自定义配置
uv run mlx-grpo.py --config my_config.toml
```

#### --set
动态覆盖配置参数（无需修改配置文件）：

```bash
# 修改学习率
uv run mlx-grpo.py --config configs/prod.toml --set learning_rate=5e-7

# 增加生成数量
uv run mlx-grpo.py --config configs/prod.toml --set num_generations=64

# 多个参数同时设置
uv run mlx-grpo.py --config configs/prod.toml \
  --set num_generations=32 \
  --set max_new_tokens=256 \
  --set temperature=0.8
```

### 参数类型转换

系统会自动处理不同类型的参数：

```bash
# 数值类型（自动转换）
--set learning_rate=5e-7      # float
--set num_generations=32      # int
--set use_compile=true        # bool

# 字符串类型（保持原样）
--set model_name="Qwen-1.5B"
--set output_dir="custom-path"
```

**段落来源**
- [mlx-grpo.py](file://mlx-grpo.py#L1140-L1175)
- [mlx-grpo.py](file://mlx-grpo.py#L380-L409)

## 典型使用场景

### 场景1：尝试不同模型

```bash
# 使用Qwen 3B模型进行实验
uv run mlx-grpo.py --config configs/prod.toml \
  --set model_name="mlx-community/Qwen2.5-3B-Instruct-4bit" \
  --set output_dir="outputs/Qwen-3B-test"
```

### 场景2：快速调试运行

```bash
# 最小化设置进行快速迭代
uv run mlx-grpo.py --config configs/smoke_test.toml
```

### 场景3：完整训练运行

```bash
# 使用所有DeepSeek参数进行完整训练
uv run mlx-grpo.py --config configs/prod.toml
```

### 场景4：创建自定义配置

```bash
# 复制并编辑配置文件
cp configs/prod.toml configs/my_experiment.toml
# 编辑 configs/my_experiment.toml 设置
uv run mlx-grpo.py --config configs/my_experiment.toml
```

### 场景5：可重现性实验

```bash
# 设置特定种子
uv run mlx-grpo.py --config configs/prod.toml --set seed=42

# 与团队共享配置文件
git add configs/my_experiment.toml
git commit -m "添加实验配置"
```

**段落来源**
- [QUICK_START.md](file://QUICK_START.md#L76-L159)

## 环境变量配置

### MLX_GRPO_CONFIG 环境变量

设置默认配置文件路径，避免每次输入完整路径：

```bash
# 一次性设置
export MLX_GRPO_CONFIG=configs/my_experiment.toml

# 然后可以这样运行
uv run mlx-grpo.py
uv run mlx-grpo.py --set seed=42
uv run mlx-grpo.py --set learning_rate=5e-7
```

### 环境变量优先级

命令行参数具有最高优先级，其次是环境变量，最后是配置文件：

```bash
# 优先级：命令行 > 环境变量 > 默认值
export MLX_GRPO_CONFIG=configs/default.toml
uv run mlx-grpo.py --config configs/smoke_test.toml  # 使用 smoke_test.toml
```

**段落来源**
- [mlx-grpo.py](file://mlx-grpo.py#L1140-L1175)

## 参数扫描与优化

### 学习率扫描

```bash
# 尝试多个学习率
for lr in 1e-6 5e-7 1e-7; do
    uv run mlx-grpo.py --config configs/prod.toml \
        --set learning_rate=$lr \
        --set output_dir="outputs/lr_${lr}"
done
```

### 参数组合扫描

```bash
# 批量测试不同参数组合
for gen in 8 16 32; do
    for temp in 0.7 0.8 0.9; do
        uv run mlx-grpo.py --config configs/prod.toml \
            --set num_generations=$gen \
            --set temperature=$temp \
            --set output_dir="outputs/gen${gen}_temp${temp}"
    done
done
```

### 成功配置保存

找到好的参数设置后，保存到配置文件：

```bash
# 发现好的设置？保存它们！
cat > configs/successful_run.toml << EOF
learning_rate = 5e-7
num_generations = 32
temperature = 0.8
seed = 42
EOF
```

**段落来源**
- [QUICK_START.md](file://QUICK_START.md#L160-L204)

## 故障排除

### 常见问题及解决方案

#### ❌ 配置文件未找到
**问题**：`Config file not found`
**解决方案**：检查路径，使用绝对路径或确保在正确目录下
```bash
uv run mlx-grpo.py --config /full/path/to/configs/default.toml
```

#### ❌ 未知配置键
**问题**：`Unknown config key`
**解决方案**：检查拼写，参考配置指南确认有效键名

#### ❌ 值类型转换失败
**问题**：`Failed to coerce value`
**解决方案**：检查值类型，CLI中数字不应加引号
```bash
# ✅ 正确
--set num_generations=32

# ❌ 错误（会导致问题）
--set num_generations="32"
```

#### ❌ 内存不足
**解决方案**：
- 使用更激进的量化（`--bits 2`）
- 减少`num_generations`和`max_new_tokens`
- 增加系统内存限制

### 调试技巧

```bash
# 启用详细输出
uv run mlx-grpo.py --config configs/smoke_test.toml --set use_compile=false

# 检查配置加载
uv run mlx-grpo.py --config configs/smoke_test.toml --set verbose=true

# 测试模型加载
uv run mlx-grpo.py --config configs/smoke_test.toml --set max_train_samples=1
```

**段落来源**
- [QUICK_START.md](file://QUICK_START.md#L160-L204)

## 下一步

### 1. 运行您的首次训练
```bash
# 使用烟雾测试配置验证一切正常
uv run mlx-grpo.py --config configs/smoke_test.toml
```

### 2. 尝试不同的设置
```bash
# 使用--set参数覆盖配置
uv run mlx-grpo.py --config configs/smoke_test.toml --set num_generations=16
```

### 3. 创建您自己的配置文件
```bash
# 复制并编辑配置
cp configs/prod.toml configs/my_experiment.toml
vim configs/my_experiment.toml  # 编辑设置
```

### 4. 探索高级功能
- 阅读完整的配置指南
- 尝试不同的模型转换
- 实验各种奖励函数

### 5. 获取更多帮助
- 📖 完整文档：[CONFIG_GUIDE.md](CONFIG_GUIDE.md)
- 📋 更新日志：[CHANGELOG.md](CHANGELOG.md)
- 🔄 迁移说明：[.config-migration-notes.md](.config-migration-notes.md)
- 📊 实现细节：[IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)

**段落来源**
- [QUICK_START.md](file://QUICK_START.md#L205-L245)

## 示例会话

以下是典型的终端会话展示使用流程：

```bash
# 终端会话显示典型用法

$ cd MLX-GRPO

# 快速测试
$ uv run mlx-grpo.py --config configs/smoke_test.toml
[config] loading configs/smoke_test.toml
================================================================================
MLX-GRPO Training Pipeline
================================================================================
Model: Qwen/Qwen2.5-1.5B-Instruct
Output Dir: outputs/smoke-test
...

# 那个工作了！尝试更多生成
$ uv run mlx-grpo.py --config configs/smoke_test.toml --set num_generations=16
[config] loading configs/smoke_test.toml
[config] applying overrides: ['num_generations=16']
...

# 创建自定义配置
$ cp configs/prod.toml configs/my_run.toml
$ vim configs/my_run.toml  # 编辑设置

# 使用自定义配置运行
$ uv run mlx-grpo.py --config configs/my_run.toml
...

# 成功！🎉
```

**段落来源**
- [QUICK_START.md](file://QUICK_START.md#L205-L245)